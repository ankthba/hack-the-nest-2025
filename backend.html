<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ALS/Eye-Tracking Communicator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <link rel="stylesheet" href="backend.css" />
  <!-- WebGazer for webcam-based gaze estimation -->
  <script src="https://cdn.jsdelivr.net/npm/webgazer/dist/webgazer.min.js"></script>
  <script defer src="backend.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">
</head>
<body>
  <a class="skip-link" href="#main">Skip to main content</a>

  <header class="app-header" role="banner">
    <div class="header-left">
      <a href="index.html" class="linkfortitle"><h1 class="sansheavy" id="app-title">IllumiSign</h1></a>
      <p class="sanslight" id="app-subtitle">ALS Eye-Tracking Communicator</p>
    </div>
    <div class="header-right">
      <button id="btnSettings" class="btn icon" aria-label="Open settings" title="Settings">
        <span aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill=rgb(255,255,255) class="bi bi-gear" viewBox="0 0 16 16">
          <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492M5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0"/>
          <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115z"/>
          </svg>
        </span>
      </button>
      <button id="btnHelp" class="btn icon" aria-label="Open help and calibration" title="Help & Calibrate">
        <span aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill=rgb(255,255,255) class="bi bi-question-lg" viewBox="0 0 16 16">
          <path fill-rule="evenodd" d="M4.475 5.458c-.284 0-.514-.237-.47-.517C4.28 3.24 5.576 2 7.825 2c2.25 0 3.767 1.36 3.767 3.215 0 1.344-.665 2.288-1.79 2.973-1.1.659-1.414 1.118-1.414 2.01v.03a.5.5 0 0 1-.5.5h-.77a.5.5 0 0 1-.5-.495l-.003-.2c-.043-1.221.477-2.001 1.645-2.712 1.03-.632 1.397-1.135 1.397-2.028 0-.979-.758-1.698-1.926-1.698-1.009 0-1.71.529-1.938 1.402-.066.254-.278.461-.54.461h-.777ZM7.496 14c.622 0 1.095-.474 1.095-1.09 0-.618-.473-1.092-1.095-1.092-.606 0-1.087.474-1.087 1.091S6.89 14 7.496 14"/>
          </svg>
        </span>
      </button>
    </div>
  </header>

  <main id="main" class="layout" role="main">
    <section class="compose" aria-labelledby="compose-heading">
      <h2 id="compose-heading" class="sansheavy composeHeading">Compose</h2>

      <div class="compose-row">
        <div class="chips" id="chipContainer" role="list" aria-label="Selected words"></div>
      </div>

      <div class="compose-row">
        <label class="visually-hidden" for="messageInput">Message text</label>
        <textarea id="messageInput" rows="2" placeholder="Message will appear here..." aria-live="polite" aria-label="Message text"></textarea>
      </div>

      <div class="compose-actions">
        <button id="btnSmartCompose" class="btn primary sanslight" title="Use AI to expand into a natural sentence">Smart Compose (AI)</button>
        <button id="btnSpeak" class="btn success sanslight" title="Speak the message aloud">Speak</button>
        <button id="btnStopSpeak" class="btn sanslight" title="Stop speaking">Stop</button>
        <button id="btnUndo" class="btn sanslight" title="Remove last word">Undo</button>
        <button id="btnClear" class="btn sanslight" title="Clear the message">Clear</button>
        <button id="btnCopy" class="btn sanslight" title="Copy message to clipboard">Copy</button>
      </div>

      <div id="aiSuggestions" class="ai-suggestions" aria-live="polite" aria-label="AI suggestions"></div>
    </section>

    <section class="grid-area" aria-labelledby="grid-heading">
      <div class="grid-toolbar">
        <h2 id="grid-heading" class="vocabHeading sansheavy">Vocabulary</h2>
        <div class="toolbar-right">
          <label class="toggle">
            <input type="checkbox" id="toggleEye" />
            <span class="sanslight">Eye Tracking</span>
          </label>
          <label class="toggle togglescan">
            <input type="checkbox" id="toggleScan" />
            <span class="sanslight">Scanning</span>
          </label>
          <button id="btnShowCategories" class="btn" aria-expanded="false" aria-controls="categoryBar">Categories</button>
        </div>
      </div>

      <nav id="categoryBar" class="category-bar" role="tablist" aria-label="Categories">
        <!-- Filled by JS -->
      </nav>

      <div id="tileGrid" class="tile-grid" role="grid" aria-label="Selectable words and images">
        <!-- Filled by JS -->
      </div>
    </section>

    <aside class="sidebar" aria-labelledby="history-heading">
      <h2 id="history-heading" class="sansheavy">History</h2>
      <ul id="historyList" class="history" aria-live="polite" aria-label="Spoken message history">
        <!-- Filled by JS -->
      </ul>

      <div class="quick-help">
        <h3 class="sansheavy">Quick Controls</h3>
        <ul>
          <li class="sanslight">Space/Enter: Select focused tile</li>
          <li class="sanslight">Arrow keys: Move focus</li>
          <li class="sanslight">S: Speak • C: Clear • U: Undo</li>
          <li class="sanslight">H: Help • G: Toggle Gaze</li>
        </ul>
      </div>
    </aside>
  </main>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle" aria-describedby="settingsDesc" hidden>
    <div class="modal-content">
      <header class="modal-header">
        <h2 id="settingsTitle">Settings</h2>
        <button id="closeSettings" class="btn icon" aria-label="Close settings">✖</button>
      </header>
      <div id="settingsDesc" class="modal-body">
        <fieldset class>
          <legend class="sanslight">Appearance</legend>
          <label class="sanslight">
            Font size
            <input type="range" id="fontSize" min="90" max="160" step="5" />
            <span id="fontSizeValue"></span>%
          </label>
          <label class="toggle">
            <input type="checkbox" id="toggleContrast" />
            <span class="sanslight">High contrast</span>
          </label>
        </fieldset>

        <fieldset>
          <legend class="sanslight">Eye Tracking</legend>
          <label class="sanslight">
            Dwell select time (ms)
            <input type="range" id="dwellTime" min="500" max="2500" step="100" />
            <span id="dwellTimeValue"></span> ms
          </label>
          <label class="toggle">
            <input type="checkbox" id="toggleGazePointer" />
            <span class="sanslight">Show gaze pointer</span>
          </label>
          <label class="toggle">
            <input type="checkbox" id="toggleShowPreviewVideo" />
            <span class="sanslight">Show camera preview (debug)</span>
          </label>
          <button id="btnCalibrate" class="btn">Calibrate</button>
        </fieldset>

        <fieldset>
          <legend class="sanslight">Scanning</legend>
          <label class="sanslight">
            Scan step (ms)
            <input type="range" id="scanSpeed" min="500" max="3000" step="100" />
            <span id="scanSpeedValue"></span> ms
          </label>
        </fieldset>

        <fieldset>
          <legend class="sanslight">Speech</legend>
          <label class="sanslight">
            Voice
            <select id="voiceSelect" aria-label="Select voice"></select>
          </label>
          <label class="toggle">
            <input type="checkbox" id="toggleAutoSpeak" />
            <span class="sanslight">Speak automatically after Smart Compose</span>
          </label>
        </fieldset>

        <fieldset>
          <legend class="sanslight">AI (Gemini)</legend>
          <label class="sanslight">
            API Key (stored locally)
            <input type="password" id="geminiKey" placeholder="Enter Gemini API Key" autocomplete="off" />
          </label>
          <small class="sanslight">Uses Gemini 1.5 Flash via client-side API. Key is saved to this browser only.</small>
        </fieldset>
      </div>
      <footer class="modal-footer">
        <button id="saveSettings" class="btn primary sansheavy">Save</button>
        <button id="cancelSettings" class="btn sansheavy">Cancel</button>
      </footer>
    </div>
  </div>

  <!-- Help / Calibration Modal -->
  <div id="helpModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="helpTitle" aria-describedby="helpDesc" hidden>
    <div class="modal-content wide">
      <header class="modal-header">
        <h2 id="helpTitle">Help & Calibration</h2>
        <button id="closeHelp" class="btn icon" aria-label="Close help">✖</button>
      </header>
      <div id="helpDesc" class="modal-body">
        <section>
          <h3>How to use</h3>
          <ol>
            <li>Turn on Eye Tracking in the toolbar, then grant camera permission.</li>
            <li>Open Calibration and click each dot a few times while looking at it.</li>
            <li>Look at a tile to select it. Holding your gaze will select it automatically.</li>
            <li>Use Smart Compose to turn selected words into a natural sentence and Speak.</li>
            <li>Accessibility: full keyboard support and scanning mode if you prefer.</li>
          </ol>
        </section>

        <section>
          <h3>Calibration</h3>
          <p>Look at each dot and click it 3 times. This improves accuracy. You can repeat anytime.</p>
          <div id="calibrationArea" class="calibration-area" aria-label="Calibration area">
            <!-- Dots injected by JS -->
          </div>
          <div class="calib-controls">
            <button id="resetCalibration" class="btn">Reset</button>
          </div>
        </section>
      </div>
      <footer class="modal-footer">
        <button id="doneHelp" class="btn primary">Done</button>
      </footer>
    </div>
  </div>

  <!-- Gaze pointer  -->
  <div id="gazePointer" aria-hidden="true"></div>

  <!-- Live region for status -->
  <div id="statusLive" class="visually-hidden" aria-live="polite"></div>
</body>
</html>